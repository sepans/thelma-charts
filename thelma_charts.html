<link rel="import" href="../bower_components/polymer/polymer.html">
      

<polymer-element name="th-statcked-chart" attributes="myData chartWidth chartHeight">
  <template>
    
    <style>

      :host {
        display: inline-block;
        position: relative;
      }

      #chart {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }

    </style>

      <svg id="stacked_chart">

      </svg>
    
  </template>

  <!-- <script src="../bower_components/d3/d3.min.js"> d3 is loaded from html page. move it to element/chart-import.html? -->

  <script>

    Polymer('th-statcked-chart', {
      myData: [{label: 'medicaid', value: 20, display_value: '$20'},{label: 'gap', value: 40, display_value: '$40'},{label: 'sub', value: 10, display_value: '$10'}],  // default data just for demo 
      chartWidth: 200,
      chartHeight: 300,
      domReady: function() {

          this.init();

      },

      init: function() {
        var margin = {
              top : 5,
              right : 0,
              bottom : 10,
              left : 0,
              label: 3
          }, width = this.chartWidth*0.95 - margin.left - margin.right, height = this.chartHeight*0.55 - margin.top - margin.bottom
             , barWidth = width* 0.12 , textLabelMargin = height*0.05;

          this.height = height;

          this.x = d3.scale.ordinal().rangeRoundBands([0, width], .1);

          var y = d3.scale.linear().range([0, height]);
          this.y = y;

          var chart_svg = this.$.stacked_chart;

          var colors = d3.scale.category10();
          colors.domain(this.myData.length);

          console.log(d3.select(chart_svg));
          this.svg = d3.select(chart_svg).attr('width', width + margin.left + margin.right)
              .attr('height', height + margin.top + margin.bottom)
              .append('g')
              .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

         // var sum = this.myData.reduce(function(prev, cur) {return prev + cur.value; }, 0);
          //console.log(sum);


          var total = 0;
          this.myData.forEach(function(d) {
              d.total = total;
              total+=d.value;
              console.log(d);
          });
          
          y.domain([0, total]); 


          this.bars = this.svg.selectAll('.bar').data(this.myData).enter().append('rect').attr('class','bar');
          //console.log(this.bars);
          this.bars
            .style('fill', function(d,i) {return colors(i);})
            .attr('x', width/2 - barWidth/2)
            //.attr('y', 0)
            .attr('y', height)
            .attr('width',barWidth)
            .attr('height', 0);

          this.labels = this.svg.selectAll('.label').data(this.myData).enter().append('text').attr('class','label');
          //console.log(this.bars);
          this.labels
            .style('fill', function(d,i) {return colors(i);})
            .style('text-anchor','end')
            .attr('x', width/2 - barWidth/2 - margin.label)
            //.attr('y', 0)
            .attr('y', height) //12: font size
            .text(function(d) {return d.label;});
          
          this.values = this.svg.selectAll('.value').data(this.myData).enter().append('text').attr('class','value');
          //console.log(this.bars);
          this.values
            .style('fill', function(d,i) {return colors(i);})
            .attr('x', width/2 + barWidth/2 + margin.label)
            //.attr('y', 0)
            .attr('y', height ) //12: font size
            .text(function(d) {return d.display_value ? d.display_value : d.value ;});

            this.animate();

          //.attr('y', function(d) {return y(d.total)});
      },

      animate: function() {

            var y = this.y;
            this.bars.transition().duration(500)//.delay(function(d,i) { return i*500;})
            .attr('y', function(d) {return y(d.total)})
            .attr('height', function(d) {return y(d.value)});

            this.labels.transition(500).duration(500)//.delay(function(d,i) { return i*500;})
            .attr('y', function(d) {return y(d.total) + 12 }); //12: font size
            
            this.values.transition(500).duration(500)//.delay(function(d,i) { return i*500;})
            .attr('y', function(d) {return y(d.total) + 12 }); //12: font size

      },
      reset: function() {
          
          height= this.height;
          this.bars.attr('y', height)
            .attr('height', 0);

          this.labels.attr('y', height );

          this.values.attr('y', height );
          
      }

      



    });
  </script>
  
</polymer-element>

